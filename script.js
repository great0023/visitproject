const initNewData = {
    fnameth: "",
    lnameth: "",
    idstudent: "",
    idstudent1: "",
    sangkud: "",
    school: "",
    term: "",
    schoolyear: "",
    nametitle: "",
    fnameen: "",
    lnameen: "",
    nickname: "",
    sex: "",
    classroom: "",
    room: "",
    numberinroom: "",
    idschool: "",
    birthday: "",
    birthmouth: "",
    birthyear: "",
    age: "",
    agemonth: "",
    bloodtype: "",
    weight: "",
    height: "",
    BMI: "",
    race: "",
    nationality: "",
    religion: "",
    disadvantages: "",
    disabilitytype: "",
    sick: "",
    educationlevel: "",
    oldschool: "",
    cityoldschool: "",
    provinceoldschool: "",
    sangkudoldschool: "",
    GPAoldschool: "",
    tel: "",
    line: "",
    facebook: "",
    addess: "",
    mooban: "",
    mootee: "",
    distric: "",
    city: "",
    province: "",
    zipcode: "",
    newaddess: "",
    newmooban: "",
    newmootee: "",
    newdistric: "",
    newcity: "",
    newprovince: "",
    newzipcode: "",
    friendnamein1: "",
    friendnicknamein1: "",
    friendschoolin1: "",
    friendtelin1: "",
    friendnamein2: "",
    friendnicknamein2: "",
    friendschoolin2: "",
    friendtelin2: "",
    friendnameout1: "",
    friendnicknameout1: "",
    friendschoolout1: "",
    friendtelout1: "",
    friendnameout2: "",
    friendnicknameout2: "",
    friendschoolout2: "",
    friendtelout2: "",
    iddad: "",
    nametitledad: "",
    fnamedad: "",
    lnamedad: "",
    agedad: "",
    workdad: "",
    salarydad: "",
    teldad: "",
    idmom: "",
    nametitlemom: "",
    fnamemom: "",
    lnamemom: "",
    agemom: "",
    workmom: "",
    salarymom: "",
    telmom: "",
    statusdadmom: "",
    idparent: "",
    nametitleparent: "",
    fnamparent: "",
    lnameparent: "",
    ageparent: "",
    workparent: "",
    salaryparent: "",
    telparent: "",
    educationparent: "",
    relationshipparent: "",
    newaddessparent: "",
    newmoobanparent: "",
    newmooteeparent: "",
    newdistricparent: "",
    newcityparent: "",
    newprovinceparent: "",
    newzipcodeparent: "",
    sickparent: "",
    bro: "",
    orderbro: "",
    allbro: "",
    amountbro: "",
    amountsis: "",
    broofdad: "",
    sisofdad: "",
    amountbrostudent: "",
    Parentalstatus: "",
    livewith: "",
    livestatus: "",
    physicalhome: "",
    safetyhome: "",
    environmenthome: "",
    electrical: "",
    water: "",
    vehicle: "",
    longschooltohome: "",
    timeschooltohome: "",
    environmentschooltohome: "",
    howschooltohome: "",
    moneyintrip: "",
    relationshipofdad: "",
    relationshipofmom: "",
    relationshipofparent: "",
    toprelationship: "",
    consultfamily: "",
    gparank_p1: "",
    gparank_p2: "",
    gparank_p3: "",
    gparank_p4: "",
    gparank_p5: "",
    gparank_p6: "",
    gparank_m1_t1: "",
    gparank_m1_t2: "",
    gparank_m2_t1: "",
    gparank_m2_t2: "",
    gparank_m3_t1: "",
    gparank_m3_t2: "",
    gparank_m4_t1: "",
    gparank_m4_t2: "",
    gparank_m5_t1: "",
    gparank_m5_t2: "",
    gparank_m6_t1: "",
    gparank_m6_t2: "",
    class_p1: "",
    class_p2: "",
    class_p3: "",
    nameteacher1_p1: "",
    nameteacher2_p1: "",
    nameteacher1_p2: "",
    nameteacher2_p2: "",
    nameteacher1_p3: "",
    nameteacher2_p3: "",
    likesubject_p1: "",
    likesubject_p2: "",
    likesubject_p3: "",
    dislikesubject_p1: "",
    dislikesubject_p2: "",
    dislikesubject_p3: "",
    maxscoresubject_p1: "",
    maxscoresubject_p2: "",
    maxscoresubject_p3: "",
    minscoresubject_p1: "",
    minscoresubject_p2: "",
    minscoresubject_p3: "",
    gpa_p1: "",
    gpa_p2: "",
    gpa_p3: "",
    likeactivity_p1: "",
    likeactivity_p2: "",
    likeactivity_p3: "",
    proud_p1: "",
    proud_p2: "",
    proud_p3: "",
    upskill_p1: "",
    upskill_p2: "",
    upskill_p3: "",
    dreamjob_p1: "",
    dreamjob_p2: "",
    dreamjob_p3: "",
    class_p4: "",
    class_p5: "",
    class_p6: "",
    nameteacher1_p4: "",
    nameteacher2_p4: "",
    nameteacher1_p5: "",
    nameteacher2_p5: "",
    nameteacher1_p6: "",
    nameteacher2_p6: "",
    likesubject_p4: "",
    likesubject_p5: "",
    likesubject_p6: "",
    dislikesubject_p4: "",
    dislikesubject_p5: "",
    dislikesubject_p6: "",
    maxscoresubject_p4: "",
    maxscoresubject_p5: "",
    maxscoresubject_p6: "",
    minscoresubject_p4: "",
    minscoresubject_p5: "",
    minscoresubject_p6: "",
    gpa_p4: "",
    gpa_p5: "",
    gpa_p6: "",
    likeactivity_p4: "",
    likeactivity_p5: "",
    likeactivity_p6: "",
    proud_p4: "",
    proud_p5: "",
    proud_p6: "",
    upskill_p4: "",
    upskill_p5: "",
    upskill_p6: "",
    dreamjob_p4: "",
    dreamjob_p5: "",
    dreamjob_p6: "",
    class_m1: "",
    class_m2: "",
    class_m3: "",
    nameteacher1_m1: "",
    nameteacher2_m1: "",
    nameteacher1_m2: "",
    nameteacher2_m2: "",
    nameteacher1_m3: "",
    nameteacher2_m3: "",
    likesubject_m1: "",
    likesubject_m2: "",
    likesubject_m3: "",
    dislikesubject_m1: "",
    dislikesubject_m2: "",
    dislikesubject_m3: "",
    maxscoresubject_m1: "",
    maxscoresubject_m2: "",
    maxscoresubject_m3: "",
    minscoresubject_m1: "",
    minscoresubject_m2: "",
    minscoresubject_m3: "",
    gpa_m1: "",
    gpa_m2: "",
    gpa_m3: "",
    likeactivity_m1: "",
    likeactivity_m2: "",
    likeactivity_m3: "",
    proud_m1: "",
    proud_m2: "",
    proud_m3: "",
    upskill_m1: "",
    upskill_m2: "",
    upskill_m3: "",
    dreamjob_m1: "",
    dreamjob_m2: "",
    dreamjob_m3: "",
    class_m4: "",
    class_m5: "",
    class_m6: "",
    nameteacher1_m4: "",
    nameteacher2_m4: "",
    nameteacher1_m5: "",
    nameteacher2_m5: "",
    nameteacher1_m6: "",
    nameteacher2_m6: "",
    likesubject_m4: "",
    likesubject_m5: "",
    likesubject_m6: "",
    dislikesubject_m4: "",
    dislikesubject_m5: "",
    dislikesubject_m6: "",
    maxscoresubject_m4: "",
    maxscoresubject_m5: "",
    maxscoresubject_m6: "",
    minscoresubject_m4: "",
    minscoresubject_m5: "",
    minscoresubject_m6: "",
    gpa_m4: "",
    gpa_m5: "",
    gpa_m6: "",
    likeactivity_m4: "",
    likeactivity_m5: "",
    likeactivity_m6: "",
    proud_m4: "",
    proud_m5: "",
    proud_m6: "",
    upskill_m4: "",
    upskill_m5: "",
    upskill_m6: "",
    dreamjob_p4: "",
    dreamjob_p5: "",
    dreamjob_m6: "",
    specialability: "",
    customCheck1: "",
    customCheck2: "",
    customCheck3: "",
    customCheck4: "",
    customCheck5: "",
    customCheck6: "",
    customCheck7: "",
    outstandingability: "",
    danger_gpa: "",
    problem_gpa: "",
    danger_habit: "",
    problem_habit: "",
    danger_factor_p: "",
    problem_factor_p: "",
    assessment_education: "",
    danger_physicalhealth: "",
    problem_physicalhealth: "",
    danger_mentalhealth: "",
    problem_mentalhealth: "",
    assessment_lhealth: "",
    danger_life: "",
    problem_life: "",
    assessment_life: "",
    danger_welfare: "",
    problem_welfare: "",
    danger_security: "",
    problem_security: "",
    assessment_security: "",
    danger_disaster: "",
    assessment_disaster: "",
    danger_trip: "",
    problem_trip: "",
    assessment_trip: "",
    danger_narcotic: "",
    problem_narcotic: "",
    assessment_narcotic: "",
    danger_severity: "",
    broblem_severity: "",
    assessment_severity: "",
    problem_sex: "",
    assessment_sex: "",
    danger_betting: "",
    problem_betting: "",
    assessment_betting: "",
    danger_telephone: "",
    problem_telephone: "",
    assessment_telephone: "",
    danger_special: "",
    problem_special: "",
    assessment_special: "",
    danger_life2: "",
    problem_life2: "",
    assessment_life2: "",
    danger_tribe: "",
    problem_tribe: "",
    assessment_tribe: "",
    visitday: "",
    visitmonth: "",
    visityear: "",
    visittimestart: "",
    visittimeend: "",
    visitinfo: "",
    visitrelationship: "",
    visitage: "",
    visitnameteacher1: "",
    visitrankteacher1: "",
    visitnameteacher2: "",
    visitrankteacher2: "",
    photovisitout: "",
    photovisitin: "",
    comment1: "",
    comment2: "",
    comment3: "",
    comment4: "",
    comment5: "",
    comment6: "",
    comment7: "",
    comment8: "",
    emotionnormal: "",
    emotionrisky: "",
    emotionproblem: "",
    conductnormal: "",
    conductrisky: "",
    conductproblem: "",
    behaviornormal: "",
    behaviorrisky: "",
    behaviorproblem: "",
    relationshipnormal: "",
    relationshipfriendproblem: "",
    sumnormal: "",
    sumrisky: "",
    sumproblem: "",
    socialrelations: "",
    socialrelationsrisky: "",
    socialrelationsproblem: "",
    relationshiprisky: ""
}

function getAge() {
    var day = parseInt(document.getElementById("birthday").value);
    var month = parseInt(document.getElementById("birthmonth").value);
    var year = parseInt(document.getElementById("birthyear").value);
    year = year - 543;
    var d = 0;
    var m = 0;
    var y = 0;
    var nowdt = new Date();
    var nd = parseInt(nowdt.getDate());
    var nm = parseInt(nowdt.getMonth());
    var ny = parseInt(nowdt.getFullYear());
    var age = parseInt(document.getElementById("age"));
    var ageYear = 0;
    var ageMonth = 0;
    d = day
    m = month + 1
    y = year
    if (d != "" && m != "" && y != "") {
        s = new Date(y, parseInt(m) - 1, d);
        d = parseInt(s.getDate());
        m = parseInt(s.getMonth());
        y = parseInt(s.getFullYear());
        ageYear = ny - y;
        if (nm > m) {
            ageMonth = nm - m;
        } else if (nm == m) {
            if (nd >= d) {
                ageMonth = 0;
            } else {
                ageMonth = 11;
                ageYear = ageYear - 1;
            }
        } else {
            ageMonth = m - nm;
            ageYear = ageYear - 1;
        }
        document.getElementById("age").value = ageYear + " ปี ";
        document.getElementById("agemonth").value = ageMonth + " เดือน";
    } else {
        age.value = "";
    }
}

function sumfinalnormal() {
    var normal1 = parseInt(document.getElementById("emotionnormal").value);
    var normal2 = parseInt(document.getElementById("conductnormal").value);
    var normal3 = parseInt(document.getElementById("behaviornormal").value);
    var normal4 = parseInt(document.getElementById("relationshipnormal").value);
    document.getElementById("sumnormal").value = normal1 + normal2 + normal3 + normal4;

}

function sumfinalrisky() {
    var risky1 = parseInt(document.getElementById("emotionrisky").value);
    var risky2 = parseInt(document.getElementById("conductrisky").value);
    var risky3 = parseInt(document.getElementById("behaviorrisky").value);
    var risky4 = parseInt(document.getElementById("relationshiprisky").value);
    document.getElementById("sumrisky").value = risky1 + risky2 + risky3 + risky4;

}

function sumfinalproblem() {
    var problem1 = parseInt(document.getElementById("emotionproblem").value);
    var problem2 = parseInt(document.getElementById("conductproblem").value);
    var problem3 = parseInt(document.getElementById("behaviorproblem").value);
    var problem4 = parseInt(document.getElementById("relationshipfriendproblem").value);
    document.getElementById("sumproblem").value = problem1 + problem2 + problem3 + problem4;

}

function calculateBmi() {
    var weight = document.getElementById("weight").value
    var height = document.getElementById("height").value
    if (weight > 0 && height > 0) {
        var finalBmi = weight / (height / 100 * height / 100)
        var meaning = "";
        if (finalBmi < 18.5) {
            meaning = " ผอม"
        }
        if (finalBmi > 18.5 && finalBmi < 25) {
            meaning = " สมส่วน"
        }
        if (finalBmi > 25) {
            meaning = " อ้วน"
        }
        document.getElementById("BMI").value = finalBmi + meaning;
    }

}

function callImage() {
    var photovisitout = document.getElementById('photovisitout');
    if (!photovisitout) return;
    photovisitout.onchange = function () {
        var filesout = photovisitout.files[0];
        var readerout = new FileReader();
        readerout.readAsDataURL(filesout);
        readerout.onload = function () {
            var resultout = readerout.result;
            document.getElementById('showImageout').src = resultout;
        };
    };
    var photovisitin = document.getElementById('photovisitin');
    photovisitin.onchange = function () {
        var filesin = photovisitin.files[0];
        var readerin = new FileReader();
        readerin.readAsDataURL(filesin);
        readerin.onload = function () {
            var resultin = readerin.result;
            document.getElementById('showImagein').src = resultin;
        };
    };
}
callImage()

function loadfirebase() {
    var firebaseConfig = {
        apiKey: "AIzaSyBq3vfRH6O7Kq3avBGZ5SbV2zLXhHvmDlU",
        authDomain: "visit-home.firebaseapp.com",
        databaseURL: "https://visit-home.firebaseio.com",
        projectId: "visit-home",
        storageBucket: "visit-home.appspot.com",
        messagingSenderId: "867176235471",
        appId: "1:867176235471:web:b80ae041f4621b1c3552ba",
        measurementId: "G-F9SZNZ7BFR"
    };
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();

    loadData()
}

async function addNew() {
    
    const db = firebase.firestore();
       await db.collection('datastudent').add(initNewData).then(res => {
        // console.log('res', );

        window.location = "form1.html?id="+res.id;
    });

    // let idx = db.collection("datastudent").get().then(doc.id)
}

function getIdFromUrl() {
    let id = window.location.search
    if(id.length <= 0) return null;

    id = id.replace('?id=', '')
    return id
}

async function save() {
    let idx = getIdFromUrl()
    const db = firebase.firestore();


    let data = await getDataId('datastudent', idx)

    // let doc = document.getElementById("iddad")
    // console.log('doc',doc);

    Object.keys(data).forEach(keyName => {
        let doc = document.getElementById(keyName)
        if(!doc) return;

        data[keyName] = document.getElementById(keyName).value

    })

    db.collection('datastudent').doc(idx).update(data).then(res => {
        //  console.log('res', res);
     })

}

async function updatedata(id) {
    window.location = "form1.html?id=" + id
    loadDataToInput()
}

async function deleteData(id) {

    const db = firebase.firestore();
    // console.log("id",id);
    db.collection('datastudent').doc(id).delete();
    //window.location.reload();
    reloadData()
}

async function reloadData() {

    let listData = await getData('datastudent')
    console.log('listData', listData)


    var dataSet = []

    listData.forEach((val, idx) => {
        dataSet.push([
            val.sangkud,
            val.school,
            val.fnameth,
            val.lnameth,
            val.idstudent,
            `<div>
        <Button class="btn btn-danger" onclick="deleteData('${val.id}')" >ลบข้อมูล</Button>
        <Button class="btn btn-info" onclick="updatedata('${val.id}')" >อัพเดทข้อมูล</Button>
        </div>`
        ])

    })

    $(document).ready(function () {
        let dataTable = $('#table').DataTable();
        dataTable.clear()
        dataTable.rows.add(dataSet)
        dataTable.draw()
    });

}

async function loadData() {

    let listData = await getData('datastudent')
    console.log('listData', listData)


    var dataSet = []

    listData.forEach((val, idx) => {
        dataSet.push([
            val.sangkud,
            val.school,
            val.fnameth,
            val.lnameth,
            val.idstudent,
            `<div>
        <Button class="btn btn-danger" onclick="deleteData('${val.id}')" >ลบข้อมูล</Button>
        <Button class="btn btn-info" onclick="updatedata('${val.id}')" >อัพเดทข้อมูล</Button>
        </div>`
        ])

    })

    $(document).ready(function () {
        if(!document.getElementById('table')) return;
        $('#table').DataTable({
            data: dataSet,
            columns: [
                { title: "สังกัด" },
                { title: "โรงเรียน" },
                { title: "ชื่อ" },
                { title: "ชื่อสกุล" },
                { title: "เลขประจำตัวประชาชน" },
                { title: "การดำเนินการ" },
            ]
        });
    });

}

async function getData(collection) {
    const db = firebase.firestore();
    let listData = []
    await db.collection(collection).get().then((snapshot) => {
        snapshot.forEach(doc => {
            listData.push({ id: doc.id, ...doc.data() })
        })
    })
    return listData
}


async function getDataId(collection, id) {
    if(!id) return;

    const db = firebase.firestore();
    let data = null
    await db.collection(collection).doc(id).get().then((snapshot) => {
        // console.log('snapshot',snapshot.data());
        data = snapshot.data()
    })
    return data
}


loadfirebase()



async function loadDataToInput() {
    let idDoc = getIdFromUrl()
    if(!idDoc) return;
    let data = await getDataId('datastudent', idDoc)
    console.log('data',data);

    Object.keys(data).forEach(keyName => {
        let doc = document.getElementById(keyName)
        if(!doc) return;

        document.getElementById(keyName).value = data[keyName]
    })

    


}
loadDataToInput()


function NextPage(nextpage) {
    let docId = getIdFromUrl()
    window.location = nextpage + '?id=' + docId

}


function formatCid(id) {
    let docValue = document.getElementById(id).value
    // console.log('docValue',docValue);
    let returnValue = ''
    // 1-2345-67890-12-3

    for (let index = 0; index < docValue.length; index++) {
        if(index === 1) returnValue += "-"
        if(index === 5) returnValue += "-"
        if(index === 10) returnValue += "-"
        if(index === 12) returnValue += "-"
        returnValue += docValue[index]
        
    }

    document.getElementById(id).value = returnValue


}

function formattel(id) {
    let docValue = document.getElementById(id).value
    // console.log('docValue',docValue);
    let returnValue = ''
    // 1-2345-67890-12-3

    for (let index = 0; index < docValue.length; index++) {
        if(index === 2) returnValue += "-"
        if(index === 6) returnValue += "-"
        returnValue += docValue[index]
        
    }

    document.getElementById(id).value = returnValue


}